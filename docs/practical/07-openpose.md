---
title: 姿态控制图像生成
toc: content
order: 7
group:
  title: 实战
---

# 姿态控制图像生成
---
## 一、工作流概述
这个工作流的核心是**利用姿态估计算法提取参考图的人体姿态，再通过 ControlNet 将该姿态约束施加到文生图过程**，最终生成“姿态与参考图一致、视觉风格由提示词定义”的全新图像。

- **输入**：参考图像（蒙娜丽莎）、正向/反向提示词
- **输出**：姿态匹配参考图、符合提示词描述的生成图像（蓝发绿眼人物）

![图片](/comfyui-doc/practical/img/openpose.png)
[下载示例文件(JSON)](/practical/json/openpose.json)

---
## 二、核心模块拆解（按流程顺序）

### 1. 基础模型加载
- **Checkpoint加载器（简易）**
  加载 Stable Diffusion 基础模型（`dreamshaper_8_全能.safetensors`），提供文生图的核心生成能力。
- **加载ControlNet模型**
  加载 ControlNet 姿态控制模型（`SDXL_control_v1p_sd15_openpose...`），用于将姿态信息注入生成流程。

### 2. 文本提示词处理
- **CLIP文本编码（正向）**
  对正向提示词 `Outstanding, high quality, blue hair, green eyes` 编码，转化为模型可理解的文本嵌入，指导图像生成的正向特征。
- **CLIP文本编码（反向）**
  对反向提示词（图中为空，通常用于抑制低质量、模糊等不良特征）编码，过滤生成中的负面元素。

### 3. 姿态提取模块
- **加载图像**
  输入参考图像（`demo01.jpg`，蒙娜丽莎），作为姿态提取的源素材。
- **DWPose Estimator**
  基于 YOLOX 和 DWPose 算法，从参考图中检测并提取人体关键点（身体、手部、面部），生成姿态骨架图。
  - 核心参数：`detect_hand`/`detect_body`/`detect_face` 均设为 `enable`，确保完整提取人体各部位姿态；`resolution` 设为 512，平衡检测精度与速度。
  - 输出：可视化的姿态关键点图像（彩色骨架图），作为 ControlNet 的控制信号。

### 4. ControlNet姿态控制
- **应用ControlNet（旧版高级）**
  接收姿态提取模块的输出、ControlNet 模型和文本嵌入，将姿态约束与文本生成需求结合。
  - 核心参数：`强度` 设为 1.0，确保姿态约束强生效；`开始百分比` 0.0、`结束百分比` 1.0，让姿态控制贯穿整个生成过程。

### 5. 图像生成与解码
- **K采样器**
  基于 Stable Diffusion 模型，结合文本嵌入和 ControlNet 约束，进行潜空间采样生成。
  - 参数：步数 20、CFG 缩放 8.0、采样器 `euler`，平衡生成速度与质量。
- **VAE解码**
  将潜空间生成的特征解码为可视化图像。
- **预览图像**
  最终输出生成结果（蓝发绿眼、姿态与蒙娜丽莎一致的人物图像）。

---
## 三、OpenPose 模型介绍

### 1. 基本定义
OpenPose 是卡内基梅隆大学（CMU）开发的**实时多人二维姿态估计算法**，是计算机视觉领域人体姿态检测的经典方案，也是 ControlNet 姿态控制的核心底层技术之一。

### 2. 核心原理
采用**自下而上**的检测思路：
1.  先检测图像中所有人体关键点（如关节、五官），生成每个关键点的热力图（Heatmap）。
2.  再通过“亲和度向量（PAF）”算法，将关键点分组匹配到对应的人体实例。

### 3. 特点与优势
- **实时性**：优化后的模型可在普通 GPU 上实现 30FPS 以上的实时检测，适用于视频流等动态场景。
- **多人支持**：无需预先检测人体边界框，可同时处理图像中的多个人体姿态。
- **多部位覆盖**：支持人体、手部、面部关键点检测，可提取完整的人体姿态信息。

### 4. 在本工作流中的应用
本工作流中使用的 **DWPose** 是 OpenPose 的优化升级版本，它结合了 YOLOX 的高精度检测能力与 DWPose 的关键点优化，相比原始 OpenPose 具有更快的速度和更高的关键点检测精度。
ControlNet 通过加载 OpenPose 预训练模型，将 DWPose 提取的姿态信息转化为生成图像的约束，从而让 AI 生成的图像严格遵循参考图的人体姿态。

---

我可以帮你整理这个工作流的**模块配置清单**，方便你后续复现或调整参数。需要吗？