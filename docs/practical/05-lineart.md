---
title: 线稿上色
toc: content
order: 5
group:
  title: 实战
---

# Lineart 线稿上色
---

## 🎯 工作流概述
本工作流是一个**二次元线稿上色+风格化生成**的完整案例，核心目标是：以一张手绘风格的二次元线稿为基础，通过 ControlNet Lineart 控制图像轮廓，结合文本提示词生成“红发金瞳+森林背景”的高质量动漫插画。

![图片](/comfyui-doc/practical/img/linear.png)
[下载示例文件(JSON)](/practical/json/linear.json)

### 核心依赖模型
| 模型类型       | 模型名称                          | 存放目录                     |
|----------------|-----------------------------------|------------------------------|
| Checkpoint（主模型） | `AnythingXL_v50-动漫.safetensors` | `ComfyUI/models/checkpoints/` |
| ControlNet（控制模型） | `SD1.5/control_v11p_sd15s2_lineart` | `ComfyUI/models/controlnet/` |
| VAE（优化模型） | `ka-f8-anime2-vae-动漫优化.safetensors` | `ComfyUI/models/vae/` |

---

## 📋 前置准备
在运行工作流前，请确保以下内容已完成：
1.  **模型部署**：将上述模型放入对应目录，ComfyUI 启动时会自动扫描加载。
2.  **素材准备**：准备一张二次元线稿图片（本案例中为 `demo1.png`），用于作为生成的轮廓参考。

---

## 🛠️ 节点详解（按数据流顺序）
### 1. Checkpoint 加载器（简易）
- **作用**：加载核心生成模型，提供图像生成的基础能力。
- **参数设置**：选择 `AnythingXL_v50-动漫.safetensors`。
- **输出连线**：
  - `模型` → 连接到「应用ControlNet」和「K采样器」的「模型」端口
  - `CLIP` → 连接到两个「CLIP文本编码」的「clip」端口
  - `VAE` → 备用（本案例使用独立加载的优化 VAE）

### 2. CLIP 文本编码（正面提示词）
- **作用**：定义生成图像的正向特征，将自然语言转换为模型可理解的向量。
- **参数设置**：
  ```
  Masterpiece, high definition, masterpiece, 1 girl, red hair, golden eyes, background: a large forest, anime style
  ```
- **输出连线**：`条件` → 连接到「应用ControlNet」和「K采样器」的「正面条件」端口

### 3. CLIP 文本编码（负面提示词）
- **作用**：定义生成图像需要避免的特征，提升画面质量。
- **参数设置**：`easynegative`（通用负面提示词，减少低质量、模糊等问题）
- **输出连线**：`条件` → 连接到「应用ControlNet」和「K采样器」的「负面条件」端口

### 4. 加载图像
- **作用**：导入需要上色的线稿底图。
- **参数设置**：选择本地线稿 `demo1.png`
- **输出连线**：`图像` → 连接到「Standard Lineart」的「image」端口

### 5. Standard Lineart（线稿预处理）
- **作用**：强化线稿的边缘特征，生成更清晰的轮廓，提升 ControlNet 的控制精度。
- **参数设置**：
  | 参数名               | 取值   | 说明                     |
  |----------------------|--------|--------------------------|
  | gaussian_sigma       | 6.00   | 高斯模糊强度，使线稿更平滑 |
  | intensity_threshold  | 8      | 对比度阈值，增强线稿明暗对比 |
  | resolution           | 512    | 预处理分辨率，与生成图像匹配 |
- **输出连线**：`图像` → 连接到「预览图像」和「应用ControlNet」的「图像」端口

### 6. 预览图像
- **作用**：实时显示预处理后的线稿效果，方便检查线稿强化是否符合预期。

### 7. 加载ControlNet模型
- **作用**：加载 Lineart 控制模型，提供线稿轮廓的约束能力。
- **参数设置**：选择 `SD1.5/control_v11p_sd15s2_lineart`
- **输出连线**：`ControlNet` → 连接到「应用ControlNet」的「ControlNet」端口

### 8. 应用ControlNet（旧版高级）
- **作用**：将线稿的控制信号注入生成流程，确保生成图像严格遵循线稿轮廓。
- **参数设置**：
  | 参数名       | 取值       | 说明                     |
  |--------------|------------|--------------------------|
  | 强度         | 1.00       | 线稿约束强度（1.0为最强约束） |
  | 开始百分比   | 0.000      | 控制信号生效起始阶段（0为全程生效） |
  | 结束百分比   | 1.000      | 控制信号生效结束阶段（1为全程生效） |
- **输出连线**：
  - `模型` → 连接到「K采样器」的「模型」端口
  - `正面条件`/`负面条件` → 连接到「K采样器」的对应端口

### 9. 空Latent图像
- **作用**：定义生成图像的分辨率和批量大小。
- **参数设置**：分辨率与输入线稿匹配（本案例为 440×672），批量大小 1
- **输出连线**：`Latent` → 连接到「K采样器」的「Latent图像」端口

### 10. K采样器
- **作用**：核心生成模块，结合模型、文本条件和线稿控制信号，生成优化后的潜空间张量。
- **参数设置**：
  | 参数名       | 取值                     | 说明                     |
  |--------------|--------------------------|--------------------------|
  | 种子         | 936902435907021（随机） | 随机种子，每次生成结果不同 |
  | 生成后控制   | randomize                | 每次生成自动更换种子       |
  | 步数         | 25                       | 采样迭代次数，平衡速度与质量 |
  | cfg         | 6.5                     | 文本提示词影响强度         |
  | 采样器名称   | dpmpp_2m                | 高效采样算法，适合二次元生成 |
  | 调度器       | karras                  | 提升采样效率与画面细节     |
  | 降噪         | 1.00                    | 完全基于线稿生成新图像（0为保留原图，1为全新生成） |
- **输出连线**：`Latent` → 连接到「VAE解码」的「Latent」端口

### 11. 加载VAE
- **作用**：加载动漫专用优化 VAE，提升最终图像的细节、色彩通透度和二次元氛围感。
- **参数设置**：选择 `ka-f8-anime2-vae-动漫优化.safetensors`
- **输出连线**：`VAE` → 连接到「VAE解码」的「vae」端口

### 12. VAE解码
- **作用**：将 K 采样器输出的潜空间张量转换为可视化图像。
- **输出连线**：`图像` → 连接到「保存图像」的「图片」端口

### 13. 保存图像
- **作用**：将生成的图像保存到本地。
- **参数设置**：文件前缀设为 `ComfyUI`（可自定义）
- **输出**：最终图像自动保存到 `ComfyUI/output/` 目录

---

## 🔄 工作流完整逻辑
1.  **输入层**：加载生成模型、线稿素材和文本提示词，完成基础准备。
2.  **预处理层**：强化线稿边缘特征，生成清晰的控制轮廓。
3.  **控制层**：通过 ControlNet 将线稿约束注入生成流程，确保轮廓精准。
4.  **生成层**：K 采样器结合模型、文本条件和线稿控制，生成潜空间张量。
5.  **解码层**：用优化 VAE 将张量转换为高质量可视化图像。
6.  **输出层**：保存生成的最终插画。

---

## 💡 参数优化技巧
1.  **线稿预处理（Standard Lineart）**：
    - 若线稿细节丢失，可降低 `gaussian_sigma`（如 4.0）；若线稿噪点过多，可提高 `gaussian_sigma`（如 8.0）。
    - 若线稿对比度不足，可提高 `intensity_threshold`（如 10）；若线稿过暗，可降低阈值（如 6）。
2.  **ControlNet 强度**：
    - 若希望线稿约束更严格（如保留手绘笔触），可设置强度为 1.0；若希望生成更自由的画面，可降低强度（如 0.7）。
3.  **采样器与步数**：
    - 选择 `dpmpp_2m_sde` 采样器可获得更细腻的画面，但生成时间更长；步数增加到 30 可提升细节，但会增加耗时。
4.  **VAE 优化**：
    - 若生成图像色彩偏灰，可更换为 `ka-f8-anime2-vae`（本案例已使用），或在提示词中添加“vibrant colors”。

---

## 🚩 常见问题与解决
- **问题1：生成图像与线稿轮廓错位**
  解决：检查 `Standard Lineart` 的分辨率是否与生成图像一致，或提高 ControlNet 强度（如 1.0）。
- **问题2：线稿细节丢失，生成画面模糊**
  解决：降低 `gaussian_sigma`（如 4.0），或增加 K 采样器的步数（如 30）。
- **问题3：色彩不自然，缺乏二次元氛围感**
  解决：确保加载 `ka-f8-anime2-vae`，并在提示词中添加“anime style, vibrant colors”。
